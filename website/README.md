# brew-monitor Front End
Web interface for the brew-monitor.

**This project is under development and not ready for the public.**

## Setup

This project is using:
 
- [http://flask.pocoo.org/](Flask)
- python **3.9**

Use the provided _requirements.txt_ file to setup your python environment.

We use SQLite which should be included as part of your python3 installation, if not see our example deployment from FreeBSD).

## Running a debug setup

**From the `website` folder**

Create a python virtual env with the required libraries :
```
$> python3.9 -m venv venv
$> source venv/bin/activate
(venv) $> pip install -r requirements.txt
```

Create the scratch folder where the debug db will be stored and optionally create dummy data:
```
(venv) $> mkdir storage
(venv) $> python python/make_dummy_data.py
```

The location of the DB can be changed in `debug_config.yaml`.

Note that the `make_dummy_data` creates two users:
- toto (admin) with the password `admin`
- titi (not admin) with the password `pass`

Start the flask debug server (from the `website` folder):
```
(venv) $> python python/run_server
```

By default, it will run on [http://localhost:5000/]()

## Unit tests

We use `pytest` for the unit tests. Follow the same steps than to run a debug setup (venv) and simply run:

```
(venv) $> pytest python/test_brewmonitor/
```

Note: if you install the packages globally (i.e. the production example) you may not need the venv to run the tests.


### Check coverage

`pytest-cov` can be used to check the coverage of the unit tests, one can check the coverage by running:

```
(venv) $> pytest --cov=brewmonitor python/test_brewmonitor/
```

Once run one can also use `coverage html` to generate a more detailed report.


## Production server install (FreeBSD/Apache/WSGI)

Reference
 - [http://flask.pocoo.org/docs/1.0/quickstart/#deploying-to-a-web-server](Flask docs)

Install the required software
```
pkg install apache24
pkg install python39
pkg install py39-sqlite3
python3.9 -m ensurepip
```

Enable Apache
```
sysrc apache24_enable=yes
service apache24 start
```

Create the certificates for HTTPS
```
mkdir /usr/local/etc/apache24/cert
cd /usr/local/etc/apache24/cert
openssl req -newkey rsa:2048 -nodes -keyout domain.key -x509 -days 365 -out domain.crt
```

Create the directory structure
```
mkdir -p /usr/local/brew-monitor/www
mkdir -p /usr/local/brew-monitor/storage
mkdir -p /usr/local/brew-monitor/config
```

Populate the git repository
```
cd /usr/local/brew-monitor/www
git clone git@github.com:jordanpenard/brew-monitor.git .
```

Install the required python libraries
```
cd website
pip3.9 install mod_wsgi
pip3.9 install -r requirements.txt
```
Note: mod_wsgi is not in the `requirements.txt` because it requires apache to be installed. 
Installing apache with `mod_wsgi` varies from system to system.

Create the WSGI script: `/usr/local/brew-monitor/config/brew-monitor.wsgi`
```python
#!/usr/local/bin/python3.9

import os
import sys

# Or use an actual env variable from your setup.
os.environ['BREWMONITOR_CONFIG'] = '/usr/local/brew-monitor/config/config.yaml'
sys.path.append('/usr/local/brew-monitor/www/website/python')

from brewmonitor.app import make_app
application = make_app('<long and random string>')
```

Create the configuration file: `/usr/local/brew-monitor/config/config.yaml`
```
sqlite file: '/usr/local/brew-monitor/storage/brew-monitor.db'
```

Create the apache module: `/usr/local/etc/apache24/modules.d/000_brew-monitor.conf`
```
LoadModule wsgi_module "/usr/local/lib/python3.9/site-packages/mod_wsgi/server/mod_wsgi-py39.so"
WSGIPythonHome "/usr/local"

<IfModule mod_ssl.c>
        Listen 443
        <VirtualHost *:443>
                ServerAdmin jordan@penard.fr

                SSLEngine on

                SSLCertificateFile    /usr/local/etc/apache24/cert/domain.crt
                SSLCertificateKeyFile /usr/local/etc/apache24/cert/domain.key

                WSGIDaemonProcess brewmonitor_ssl threads=1 display-name=wsgi:brewmonitor request-timeout=105
                WSGIScriptAlias / /usr/local/brew-monitor/config/brew-monitor.wsgi
                DocumentRoot "/usr/local/brew-monitor/www/website"
                <Directory /usr/local/brew-monitor/>
                    Options FollowSymLinks Includes
                    AllowOverride All
                    Require all granted
                </Directory>

        </VirtualHost>
</IfModule>
```

Restart Apache
```
service apache24 restart
```

Note: The top part of the vhost config was generated by the following command : `mod_wsgi-express module-config`

## Storage API

The server should provide a `/storage/sensor/add_data` path that expects the data as JSON.

### Parameters

The API is expecting only 1 entry per call with the following fields:

* `sensor_id`: the sensor ID in the DB, as an integer.
* `angle`: as a floating point number encoded in a string, in degrees. The calibration process will allow to compute a gravity measure.
* `temperature`: as a floating point number encoded in a string. The unit is expected to be Celsius.
* `battery`: as an floating point number encoded in a string. The unit is expected to be Volt, the calibration process will allow to compute a battery percentage.

### Response

The API will search the DB for the provided sensor ID and find the matching project.

* `created`: list of objects that have the attributes:
    * all the parameters listed above, and:
    * `project_id`: the project ID that was found, as an integer. If the project was not found will return _null_.
    * `timestamp`: when was the recording stored, as an integer. This is in seconds since Epoch.

### E.g. of usage

```
$> curl \
  -H "Content-Type: application/json" \
  http://localhost:5000/storage/sensor/add_data \
  -d '{"sensor_id": 1, "angle": "14.3", "temperature": "20.3", "battery": "2.6", "secret": "secret"}'

{"created": [{"sensor_id": 1, "project_id": 1, "timestamp": 1554034368, "angle": "15.5", "temperature": "20.5", "battery": 2800}]}
```

## TODO

- [x] use sqlite to store the data
- [x] create pages to create projects and sensors
- [x] add _angle_ as float in the parameters
- [ ] set calibration data
- [ ] workout how to compute _gravity_ from _angle_
- [ ] workout how to compute _battery_percent_ from _battery_
- [ ] fix SQL to display sensor when it does not have data (last_active is broken)
- [x] delete datapoints
